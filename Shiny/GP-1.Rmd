---
title: "Cancer Analysis"
runtime: shiny
---

```{r setup, include=FALSE}
library(shiny)
library(shinyjs)
library(magick)
library(rmarkdown)
library(lubridate)
library(reticulate)
```

```{r app, echo=FALSE}
#Denoiser file for denoiser model
available_denoisers <- list.files("denoiser", pattern = "\\.Rmd$", full.names = FALSE)
available_denoisers <- gsub("\\.Rmd$", "", available_denoisers)
if (length(available_denoisers) > 0) {
  available_denoisers <- gsub("\\.Rmd$", "", list.files("denoiser", pattern = "\\.Rmd$"))
  available_denoisers <- c(available_denoisers, "None")
} else {
  available_denoisers <- "None"
}
#Model file for model
available_models <- list.files("Model", pattern = "\\.Rmd$", full.names = FALSE)
available_models <- gsub("\\.Rmd$", "", available_models)
# UI
ui <- fluidPage(
  useShinyjs(),
  titlePanel("Cancer Analysis"),
  fluidRow(
    column(3,
      tags$style(HTML(".step-box { padding: 10px; margin-bottom: 15px; border-radius: 5px; background-color: #f1f1f1; text-align: center; }
                       .step-active { background-color: #d4edda !important; font-weight: bold; border-left: 5px solid #28a745; }")),
      div(id = "step1_box", class = "step-box step-active", "Step 1: Upload Image"),
      div(id = "step2_box", class = "step-box", "Step 2: Denoise"),
      div(id = "step3_box", class = "step-box", "Step 3: Analyze"),
      div(id = "step4_box", class = "step-box", "Step 4: View Result")
    ),
    column(9,
      uiOutput("stage_ui"),
      br(),
      fluidRow(
        column(6, hidden(actionButton("prev_step", "Previous Step", class = "btn btn-secondary"))),
        column(6, align = "right", hidden(actionButton("next_step", "Next Step", class = "btn btn-success")))
      )
    )
  )
)
server <- function(input, output, session) {
  step <- reactiveVal(1)
  img_path <- reactiveVal()
  denoised_img_path <- reactiveVal()
  cancer_score <- reactiveVal()

  # Display on legend
  observe({
    lapply(1:4, function(i) {
      shinyjs::removeClass(paste0("step", i, "_box"), "step-active")
    })
    shinyjs::hide("next_step")
    shinyjs::hide("prev_step")
    shinyjs::addClass(paste0("step", step(), "_box"), "step-active")
    if (step() > 1) shinyjs::show("prev_step")
  })

  observeEvent(step(), {
    output$stage_ui <- renderUI({
      switch(step(),
        # Step 1
        div(
          fileInput("img_file", "Upload an Image", accept = c(".jpg", ".jpeg", ".png")),
          imageOutput("input_image")
        ),
        # Step 2
        div(
          h4("Denoise Image"),
          selectInput("denoise_model", "Denoising Model", choices = available_denoisers, selected = available_denoisers[1]),
          actionButton("run_denoiser", "Run Denoiser", class = "btn btn-primary mb-3"),
          textOutput("denoiser_status"),
          fluidRow(
            column(6, h5("Original Image"), imageOutput("input_image_preview")),
            column(6, h5("Denoised Image"), imageOutput("denoised_image"))
          )
        ),
        # Step 3
        div(
          h4("Select Analysis Model"),
          selectInput("analysis_model", "Model", choices = available_models),
          actionButton("run_analysis", "Run Analysis", class = "btn btn-primary")
        ),
        # Step 4
        div(
          h4("Prediction Result"),
          fluidRow(
            column(6, h5("active heatmap"), imageOutput("heatmap_img", width = "100%")),
            column(6, h5("Outline"), imageOutput("contour_img", width = "100%"))
          ),
          verbatimTextOutput("pred_label"),
          verbatimTextOutput("pred_conf"),
          br(),
          actionButton("finish_btn", "Finish", class = "btn btn-danger")
        )
      )
    })
  })

  # Step 1: Upload and process image
  observeEvent(input$img_file, {
    req(input$img_file)
      if (file.exists("image") && !dir.exists("image")) {
      file.remove("image")
    }
    dir.create("image", showWarnings = FALSE)
    uploaded_path <- file.path("image", "uploaded.jpg")
    file.copy(input$img_file$datapath, uploaded_path, overwrite = TRUE)
    img_path(uploaded_path)
    output$input_image <- renderImage({
      list(src = uploaded_path, contentType = input$img_file$type, width = 300)
    }, deleteFile = FALSE)
    shinyjs::show("next_step")
  })

  # Step 2: Run Denoiser
  observeEvent(input$run_denoiser, {
    req(img_path())
    input_img <- normalizePath(file.path("image", "uploaded.jpg"))
    output_img <- normalizePath(file.path("image", "denoised.jpg"))
    rmd_file <- file.path("denoiser", paste0(input$denoise_model, ".Rmd"))
    if (!file.exists(rmd_file)) {
      output$denoiser_status <- renderText(paste("Cannot find:", rmd_file))
      return()
    }
    if (input$denoise_model != "None") {
      rmarkdown::render(rmd_file, params = list(
        input_img = input_img,
        output_img = output_img,
        method = input$denoise_model
      ), quiet = TRUE)
      output$denoiser_status <- renderText("Denoising successful.")
    } else {
      file.copy(input_img, output_img, overwrite = TRUE)
      output$denoiser_status <- renderText("No denoising applied.")
    }
    denoised_img_path(output_img)
    output$input_image_preview <- renderImage({
      list(src = input_img, contentType = "image/jpeg", width = 300)
    }, deleteFile = FALSE)
    output$denoised_image <- renderImage({
      list(src = output_img, contentType = "image/jpeg", width = 300)
    }, deleteFile = FALSE)
    shinyjs::show("next_step")
  })

  # Step 3: Run Analysis Model
  observeEvent(input$run_analysis, {
    showModal(modalDialog("Running model analysis...", footer = NULL))
    Sys.sleep(1)
    output_img <- file.path("image", "denoised.jpg")
    if (!file.exists(output_img)) {
      showNotification("Denoised image not found", type = "error")
      removeModal()
      return()
    }
    output_txt <- file.path("image", "result.txt")
    
    rmd_model <- file.path("Model", paste0(input$analysis_model, ".Rmd"))
    if (file.exists(rmd_model)) {
      rmarkdown::render(rmd_model, params = list(
        input_img = output_img,
        result_txt = output_txt
      ), quiet = TRUE)
    }
    score_txt <- file.path("image", "result.txt")
    if (file.exists(score_txt)) {
      score_val <- as.numeric(readLines(score_txt, warn = FALSE))
      score_val <- max(0, min(1, score_val))
    } else {
      score_val <- NA
    }
    cancer_score(score_val)
    output$pred_label <- renderText({
      paste("Predicted Label:", ifelse(is.na(score_val), "N/A", ifelse(score_val > 0.5, "Cancer", "Benign")))
    })
    output$pred_conf <- renderText({
      paste("Confidence:", ifelse(is.na(score_val), "N/A", sprintf("%.2f%%", score_val * 100)))
    })
    output$heatmap_img <- renderImage({
      list(src = "image/heatmap.png", contentType = "image/png", width = "100%")
    }, deleteFile = FALSE)
    output$contour_img <- renderImage({
      list(src = "image/contour.png", contentType = "image/png", width = "100%")
    }, deleteFile = FALSE)
    removeModal()
    shinyjs::show("next_step")
  })

  # Step 4: Finish
  observeEvent(input$finish_btn, {
    score <- cancer_score()
    percent <- paste0(round(score * 100, 2), "%")
    model <- input$analysis_model
    final_img <- file.path("image", "denoised.jpg")
    sydney_time <- format(with_tz(Sys.time(), "Australia/Sydney"), "%Y-%m-%d_%H-%M-%S")
    dir.create("result", showWarnings = FALSE)
    out_img <- file.path("result", paste0(sydney_time, "_final_image.jpg"))
    out_txt <- file.path("result", paste0(sydney_time, "_result.txt"))
    file.copy(final_img, out_img, overwrite = TRUE)
    writeLines(
      c(
        paste("Cancer Likelihood:", percent),
        paste("Model Used:", model),
        paste("Image Saved:", out_img)
      ),
      con = out_txt
    )
    unlink(list.files("image", full.names = TRUE), recursive = TRUE)
    stopApp()
  })

  # Step navigation
  observeEvent(input$next_step, {
    if (step() < 4) step(step() + 1)
  })
  observeEvent(input$prev_step, {
    if (step() > 1) step(step() - 1)
  })
}

shinyApp(ui, server)
```
