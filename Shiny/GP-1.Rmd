---
title: "Cancer Analysis"
runtime: shiny
---

```{r setup, include=FALSE}
library(shiny)
library(shinyjs)
library(magick)
library(rmarkdown)
library(lubridate)
library(reticulate)
```

```{r}
use_python("/usr/bin/python3", required = TRUE)

source_python("analysis.py")
```

```{r app, echo=FALSE}
#Denoiser file for denoiser model
available_denoisers <- list.files("denoiser", pattern = "\\.Rmd$", full.names = FALSE)
available_denoisers <- gsub("\\.Rmd$", "", available_denoisers)
available_denoisers <- c("None", available_denoisers)
#Model file for model
available_models <- list.files("Model", pattern = "\\.Rmd$", full.names = FALSE)
available_models <- gsub("\\.Rmd$", "", available_models)
# UI
ui <- fluidPage(
  useShinyjs(),
  titlePanel("Cancer Analysis"),
  fluidRow(
    column(3,
      tags$style(HTML(".step-box { padding: 10px; margin-bottom: 15px; border-radius: 5px; background-color: #f1f1f1; text-align: center; }
                       .step-active { background-color: #d4edda !important; font-weight: bold; border-left: 5px solid #28a745; }")),
      div(id = "step1_box", class = "step-box step-active", "Step 1: Upload Image"),
      div(id = "step2_box", class = "step-box", "Step 2: Denoise"),
      div(id = "step3_box", class = "step-box", "Step 3: Analyze"),
      div(id = "step4_box", class = "step-box", "Step 4: View Result")
    ),
    column(9,
      uiOutput("stage_ui"),
      br(),
      fluidRow(
        column(6, hidden(actionButton("prev_step", "Previous Step", class = "btn btn-secondary"))),
        column(6, align = "right", hidden(actionButton("next_step", "Next Step", class = "btn btn-success")))
      )
    )
  )
)
server <- function(input, output, session) {
  step <- reactiveVal(1)
  img_path <- reactiveVal()
  denoised_img_path <- reactiveVal()
  cancer_score <- reactiveVal()
  # Display on legend
  observe({
    lapply(1:4, function(i) {
      shinyjs::removeClass(paste0("step", i, "_box"), "step-active")
    })
    shinyjs::hide("next_step")
    shinyjs::hide("prev_step")
    shinyjs::addClass(paste0("step", step(), "_box"), "step-active")
    if (step() > 1) shinyjs::show("prev_step")
  })
  observeEvent(step(), {
    output$stage_ui <- renderUI({
      switch(step(),
        # Step 1
        div(
          fileInput("img_file", "Upload an Image", accept = c(".jpg", ".jpeg", ".png")),
          imageOutput("input_image")
        ),
        # Step2
        div(
          h4("Denoise Image"),
          selectInput("denoise_model", "Denoising Model", choices = available_denoisers),
          actionButton("run_denoiser", "Run Denoiser", class = "btn btn-primary mb-3"),
          textOutput("denoiser_status"),
          fluidRow(
            column(6, h5("Original Image"), imageOutput("input_image_preview")),
            column(6, h5("Denoised Image"), imageOutput("denoised_image"))
          )
        ),
        # Step3
        div(
          h4("Select Analysis Model"),
          selectInput("analysis_model", "Model", choices = available_models),
          actionButton("run_analysis", "Run Analysis", class = "btn btn-primary")
        ),
        # Step4
        div(
          h4("Prediction Result"),
          fluidRow(
            column(6,
              h5("active heatmap"),
              imageOutput("heatmap_img", width = "100%")
            ),
            column(6,
              h5("Outline"),
              imageOutput("contour_img", width = "100%")
            )
          ),
          verbatimTextOutput("pred_label"),
          verbatimTextOutput("pred_conf"),
          br(),
          actionButton("finish_btn", "Finish", class = "btn btn-danger")
        )
      )
    })
  })
  # phoro upload and copy
  observeEvent(input$run_analysis, {
    req(denoised_img_path())
    showModal(modalDialog("Running model analysis", footer = NULL))

    img_file <- normalizePath(denoised_img_path())
    transform_name <- input$denoise_model

    result <- py$get_heatmap(py$Image$open(img_file), transform_name)
    pred <- py$predict(py$Image$open(img_file), transform_name)

    predicted_label <- pred[[1]]
    confidence      <- pred[[2]]

    output$heatmap_img <- renderImage({
      list(src = "image/heatmap.png", contentType = "image/png", width = "100%")
    }, deleteFile = FALSE)
    
    output$contour_img <- renderImage({
      list(src = "image/contour.png", contentType = "image/png", width = "100%")
    }, deleteFile = FALSE)
    
    output$pred_label <- renderText({
      paste("Predicted Label:", predicted_label)
    })
    output$pred_conf <- renderText({
      paste("Confidence:", sprintf("%.2f%%", confidence))
    })
    
    removeModal()
    shinyjs::show("next_step")
  })

  # pick denoiser  n run
  observeEvent(input$run_denoiser, {
    req(img_path())
    input_img <- normalizePath(file.path("image", "uploaded.jpg"))
    output_img <- normalizePath(file.path("image", "denoised.jpg"))
    rmd_file <- file.path("denoiser", paste0(input$denoise_model, ".Rmd"))
    if (!file.exists(rmd_file)) {
      output$denoiser_status <- renderText(paste("Cannot find:", rmd_file))
      return()
    }
    if (input$denoise_model != "None") {
      rmarkdown::render(rmd_file, params = list(
        input_img = input_img,
        output_img = output_img,
        method = input$denoise_model
      ), quiet = TRUE)
      output$denoiser_status <- renderText("Denoising successful.")
    } else {
      file.copy(input_img, output_img, overwrite = TRUE)
      output$denoiser_status <- renderText("No denoising applied.")
    }
    denoised_img_path(output_img)
    output$denoised_image <- renderImage({ list(src = output_img, contentType = "image/jpeg", width = 300) }, deleteFile = FALSE)
    shinyjs::show("next_step")
  })
  # pick model in file n run
  observeEvent(input$run_analysis, {
    showModal(modalDialog("Running model analysis...", footer = NULL))
    Sys.sleep(1)
    output_img <- file.path("image", "denoised.jpg")
    rmd_model <- file.path("Model", paste0(input$analysis_model, ".Rmd"))
    if (file.exists(rmd_model)) {
      rmarkdown::render(rmd_model, params = list(
        input_img = normalizePath(output_img),
        output_txt = normalizePath(file.path("image", "result.txt"))
      ), quiet = TRUE)
    }
    score_txt <- file.path("image", "result.txt")
    if (file.exists(score_txt)) {
      score_val <- as.numeric(readLines(score_txt, warn = FALSE))
      score_val <- max(0, min(1, score_val))
    } else {
      score_val <- NA
    }
    cancer_score(score_val)
    cancer_score(score)
    output$cancer_likelihood <- renderText({
      paste("Cancer Likelihood:", round(score * 100, 2), "%")
    })
    output$output_image <- renderPlot({
      img <- image_read(output_img)
      plot(img)
    })
    removeModal()
    shinyjs::show("next_step")
  })
  
  # finish result
  observeEvent(input$finish_btn, {
    score <- cancer_score()
    percent <- paste0(round(score * 100, 2), "%")
    model <- input$analysis_model
    final_img <- file.path("image", "denoised.jpg")
    sydney_time <- format(with_tz(Sys.time(), "Australia/Sydney"), "%Y-%m-%d_%H-%M-%S")
    dir.create("result", showWarnings = FALSE)
    out_img <- file.path("result", paste0(sydney_time, "_final_image.jpg"))
    out_txt <- file.path("result", paste0(sydney_time, "_result.txt"))
    file.copy(final_img, out_img, overwrite = TRUE)
    writeLines(
      c(
        paste("Cancer Likelihood:", percent),
        paste("Model Used:", model),
        paste("Image Saved:", out_img)
      ),
      con = out_txt
    )
    unlink(list.files("image", full.names = TRUE), recursive = TRUE)
    stopApp()
  })
  # step before and after
  observeEvent(input$next_step, {
    if (step() < 4) step(step() + 1)
  })
  observeEvent(input$prev_step, {
    if (step() > 1) step(step() - 1)
  })
}
shinyApp(ui, server)
```
